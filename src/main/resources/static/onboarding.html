<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>추가 정보 입력</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<main class="onboarding">
  <h1>추가 정보 입력</h1>
  <p>서비스 이용을 위해 휴대폰 번호를 입력해 주세요.</p>
  <form id="obForm">
    <label>휴대폰 번호
      <input id="phone" name="phone" type="tel" inputmode="numeric" autocomplete="tel-national" placeholder="010-1234-5678" required>
    </label>
    <button type="submit">완료</button>
  </form>
  <div id="loginLinkBox" style="display:none;">
    <p>기존 계정으로 로그인하면 연결됩니다.</p>
    <a id="loginToLinkCta" class="btn">로그인하러 가기</a>
  </div>
  <p id="err" style="color:#c00; display:none;"></p>
</main>
<script>
  function getCookie(n){return document.cookie.split('; ').find(r=>r.startsWith(n+'='))?.split('=')[1];}

  function formatKRPhone(v) {
    const d = (v || '').replace(/\D/g, ''); // 숫자만
    if (!d) return '';

    // 특수 대표번호 (1588/1600/1666/1800 등)
    if (/^(15|16|18)\d{2}/.test(d)) {
      if (d.length <= 4) return d;
      return d.slice(0,4) + '-' + d.slice(4,8);
    }

    // 서울 국번 (02)
    if (d.startsWith('02')) {
      if (d.length <= 2) return d;
      if (d.length <= 5) return d.slice(0,2) + '-' + d.slice(2);
      if (d.length <= 9)  return d.slice(0,2) + '-' + d.slice(2,5) + '-' + d.slice(5);
      return d.slice(0,2) + '-' + d.slice(2,6) + '-' + d.slice(6,10);
    }

    // 050/070/010 등 이동통신/특수번호 3자리 지역코드
    const ac3 = d.slice(0,3);
    if (/^(010|070|050|051|052|053|054|055|031|032|033|041|042|043|044|061|062|063|064)$/.test(ac3)) {
      if (d.length <= 3) return d;
      if (d.length <= 7) return d.slice(0,3) + '-' + d.slice(3);
      if (d.length === 10) return d.slice(0,3) + '-' + d.slice(3,6) + '-' + d.slice(6);
      return d.slice(0,3) + '-' + d.slice(3,7) + '-' + d.slice(7,11);
    }

    // 그 외 일반 번호: 3-3/4-4
    if (d.length <= 3) return d;
    if (d.length <= 7) return d.slice(0,3) + '-' + d.slice(3);
    if (d.length === 10) return d.slice(0,3) + '-' + d.slice(3,6) + '-' + d.slice(6);
    return d.slice(0,3) + '-' + d.slice(3,7) + '-' + d.slice(7,11);
  }

  // 입력 시 자동 하이픈
  const phoneInput = document.getElementById('phone');
  if (phoneInput) {
    phoneInput.addEventListener('input', () => {
      const cur = phoneInput.value;
      const next = formatKRPhone(cur);
      if (cur !== next) {
        const posFromEnd = cur.length - phoneInput.selectionStart;
        phoneInput.value = next;
        // caret을 가능하면 끝에서 유지
        const newPos = Math.max(0, phoneInput.value.length - posFromEnd);
        phoneInput.setSelectionRange(newPos, newPos);
      }
    });

    // 붙여넣기 방어(숫자만 유지)
    phoneInput.addEventListener('paste', e => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData('text');
      const digits = (text || '').replace(/\D/g,'');
      const formatted = formatKRPhone(digits);
      phoneInput.value = formatted;
    });
  }

  function showError(msg){
        const el = document.getElementById('err');
        if (!el) { alert(msg); return; }
        el.textContent = msg;
        el.style.display = 'block';
        el.setAttribute('role','alert');
        el.setAttribute('aria-live','assertive');
  }
  function showInfo(msg){
    showError(msg);
  }

  document.getElementById('obForm').addEventListener('submit', async (e)=>{
    e.preventDefault();

    const btn = document.querySelector('#obForm button[type=submit]');
    btn.disabled = true; const oldText = btn.textContent; btn.textContent = '처리 중.';

    const raw = (phoneInput?.value ?? '');
    const phone = raw.replace(/\D/g,'');
    if (!phone) { showError('휴대폰 번호를 입력해 주세요.'); btn.disabled=false; btn.textContent=oldText; return; }

    const xsrf = getCookie('XSRF-TOKEN');

    try {
      const r = await fetch('/api/onboarding', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'X-XSRF-TOKEN': xsrf },
        credentials:'same-origin',
        body: JSON.stringify({ phoneNumber: phone })
      });

      // 성공(신규 생성 & 자동 로그인)
      if (r.ok) { location.href = '/main'; return; }

      // 실패/유도 케이스 공통 파싱
      let body = {};
      try { body = await r.json(); } catch(e){}

      // 세션 없음
      if (r.status === 400 && body.code === 'NO_PENDING') {
        showError('세션이 만료되었습니다. 소셜 로그인을 다시 시도해 주세요.');
        setTimeout(()=> location.href='/login', 1200);
        return;
      }

      // 권한/CSRF
      if (r.status === 401) { showError('로그인이 필요합니다. 다시 시도해 주세요.'); return; }
      if (r.status === 403) { showError('요청이 거부되었습니다. 잠시 후 다시 시도해 주세요.'); return; }

      // 전화번호 형식
      if (r.status === 400 && body.code === 'INVALID_PHONE') {
        showError('휴대폰 번호 형식이 올바르지 않습니다.');
        return;
      }

      // 여기! 기존 계정 존재 → 로그인 유도(연결)
      if (r.status === 202 && body.code === 'LOGIN_TO_LINK') {
        showInfo('기존 계정이 있어요. 로그인하면 연결됩니다.');
        const cta = document.getElementById('loginToLinkCta');
        cta.href = (body.nextUrl || '/login?next=/api/oauth/link/confirm'); // /api prefix 제거
        document.getElementById('obForm').style.display = 'none';
        document.getElementById('loginLinkBox').style.display = 'block';
        return;
      }

      // 그 외
      showError(body.message || ('서버 오류: ' + r.status));
    } catch (err) {
      showError(err.message || '저장 실패');
    } finally {
      btn.disabled = false; btn.textContent = oldText;
    }
  });
</script>
</body>
</html>
