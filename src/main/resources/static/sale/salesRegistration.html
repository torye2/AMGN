<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>판매 글 작성</title>
    <link rel="stylesheet" href="../css/reset.css" />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="stylesheet" href="../css/salesRegistration.css" />
</head>
<body>
<div id="wrap">
    <div>
        <header id="header"></header>
    </div>
    <div class="container">
        <fieldset class="sales-box">
            <h2>판매 글 작성</h2>
            <form id="salesForm">
                <div>
                    <label>제품 이름
                        <input type="text" name="title" required /></label>
                </div>
                <div>
                    <label>제품 가격
                        <input type="number" name="price" required /></label>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="negotiable" value="Y" />
                        가격 협상 가능
                    </label>
                </div>
                <div>
                    <label>카테고리
                        <select name="categoryId" required>
                            <option value="1">디지털기기</option>
                            <option value="2">남성의류</option>
                            <option value="3">여성의류</option>
                            <option value="4">남성신발</option>
                            <option value="5">여성신발</option>
                            <option value="6">가전제품</option>
                            <option value="7">상품권</option>
                            <option value="8">가구</option>
                        </select> </label>
                </div>
                <div class="radio-group">
                    <p>제품 상태:</p>
                    <label><input type="radio" name="itemCondition" value="NEW" required /> 새상품</label>
                    <label><input type="radio" name="itemCondition" value="LIKE_NEW" /> 거의 새것</label>
                    <label><input type="radio" name="itemCondition" value="GOOD" /> 사용감 적음</label>
                    <label><input type="radio" name="itemCondition" value="FAIR" /> 사용감 많음</label>
                    <label><input type="radio" name="itemCondition" value="POOR" /> 고장/파손</label>
                </div>
                <div>
                    <label>제품 설명
                        <textarea name="description" required></textarea></label>
                </div>
                <div class="radio-group" id="trade-type-radio">
                    <p>거래 방식:</p>
                    <label><input type="radio" name="tradeType" value="DELIVERY" required /> 택배</label>
                    <label><input type="radio" name="tradeType" value="MEETUP" /> 직거래</label>
                    <label><input type="radio" name="tradeType" value="BOTH" checked /> 모두 가능</label>
                </div>

                <div id="location-field">
                    <label>거래 희망 지역
                        <input type="text" name="region" required /></label>
                </div>

                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" name="safePayYn" value="Y" />
                        안전 결제 가능
                    </label>
                </div>
                <div>
                    <label>제품 사진
                        <input type="file" name="productPhotos" multiple /></label>
                </div>

                <div class="attr-section">
                    <h3>제품 부가 정보 (선택 사항)</h3>
                    <div id="attributes">
                        <div class="attr-item">
                            <input type="text" name="attrKey[]" placeholder="속성명 (예: 사이즈)" />
                            <input type="text" name="attrValue[]" placeholder="속성값 (예: XL)" />
                        </div>
                    </div>
                    <div class="attr-buttons">
                        <button type="button" onclick="addAttributeField()">항목 추가</button>
                    </div>
                </div>

                <button type="submit">등록하기</button>
                <div id="message"></div>
            </form>
        </fieldset>
    </div>
</div>
<script>
    function addAttributeField() {
        const attributesDiv = document.getElementById('attributes');
        const newItem = document.createElement('div');
        newItem.classList.add('attr-item');
        newItem.innerHTML = `
            <input type="text" name="attrKey[]" placeholder="속성명 (예: 색상)" />
            <input type="text" name="attrValue[]" placeholder="속성값 (예: 흰색)" />
            <button type="button" onclick="this.parentNode.remove()">삭제</button>
        `;
        attributesDiv.appendChild(newItem);
    }

    const salesForm = document.getElementById('salesForm');
    const messageDiv = document.getElementById('message');

    salesForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        messageDiv.textContent = "저장 중입니다...";
        messageDiv.style.color = "blue";

        try {
            // FormData 객체를 사용하여 폼 데이터와 파일을 모두 포함
            const formData = new FormData(salesForm);

            // 동적 속성(attrs)을 JSON 배열로 수집합니다.
            const attrKeys = formData.getAll('attrKey[]');
            const attrValues = formData.getAll('attrValue[]');
            const attrs = [];
            for (let i = 0; i < attrKeys.length; i++) {
                if (attrKeys[i].trim() !== '' && attrValues[i].trim() !== '') {
                    attrs.push({
                        attrKey: attrKeys[i],
                        attrValue: attrValues[i]
                    });
                }
            }

            // 파일 업로드와 JSON 데이터를 한 번에 보내기 위해
            // 일반 텍스트 데이터는 JSON 문자열로 변환하여 FormData에 추가
            const listingData = {
                title: formData.get('title'),
                price: parseFloat(formData.get('price')),
                // 이 부분을 아래와 같이 수정하세요.
                negotiable: formData.get('negotiable') ? 'Y' : 'N',
                categoryId: parseInt(formData.get('categoryId')),
                itemCondition: formData.get('itemCondition'),
                description: formData.get('description'),
                tradeType: formData.get('tradeType'),
                // ⚠️ 주의: 'region'은 백엔드에서 'regionId'로 변환해야 함
                region: formData.get('region'),
                safePayYn: formData.get('safePayYn') ? 'Y' : 'N'
            };

            // 기존 FormData의 필드는 제거하고 JSON 문자열로 대체하여 보냅니다.
            formData.set('listingData', JSON.stringify(listingData));
            formData.set('attrs', JSON.stringify(attrs));

            // 'attrKey[]', 'attrValue[]', 'title', 'price' 등은 더 이상 필요 없으므로 제거
            formData.delete('attrKey[]');
            formData.delete('attrValue[]');
            formData.delete('title');
            formData.delete('price');
            //... 다른 필드들도 모두 제거

            const response = await fetch('/product/write', {
                method: 'POST',
                body: formData, // FormData 객체를 그대로 전송
            });

            const result = await response.json();

            if (response.ok) {
                messageDiv.textContent = result.message;
                messageDiv.style.color = "green";
                salesForm.reset();
            } else {
                messageDiv.textContent = result.error || "알 수 없는 오류가 발생했습니다.";
                messageDiv.style.color = "red";
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            messageDiv.textContent = "등록에 실패했습니다. 네트워크 연결을 확인해주세요.";
            messageDiv.style.color = "red";
        }
    });
</script>
<script src="../js/header.js"></script>
</body>
</html>