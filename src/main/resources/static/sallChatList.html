<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>판매 채팅 목록</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; }
        h1 { margin-bottom: 16px; }
        #status { margin-bottom: 12px; color: #555; }
        ul { list-style: none; padding: 0; }
        li {
          padding: 12px 14px;
          border: 1px solid #e5e7eb;
          border-radius: 10px;
          margin-bottom: 10px;
          cursor: pointer;
          transition: background 0.15s ease-in-out;
        }
        li:hover { background: #f8f9fb; }
        .meta { font-size: 13px; color: #666; margin-top: 4px; }
        .empty { color: #999; }
        .error { color: #d33; white-space: pre-line; margin-top: 12px; }
    </style>
</head>
<body>
<h1>판매 채팅 목록</h1>
<div id="status">로그인 상태 확인 중...</div>
<ul id="chatRooms"></ul>
<div id="error" class="error"></div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
      const statusEl = document.getElementById('status');
      const listEl   = document.getElementById('chatRooms');
      const errorEl  = document.getElementById('error');

      try {
        // 1) 로그인 사용자 조회
        const meRes = await fetch('/api/user/me', { cache: 'no-store', credentials: 'include' });
        if (!meRes.ok) throw new Error('로그인 사용자 조회 실패');
        const me = await meRes.json();

        if (!me.loggedIn) {
          statusEl.textContent = '로그인이 필요합니다.';
          alert('로그인이 필요합니다.');
          location.href = '/login.html';
          return;
        }

        const myUserId = me.userId; // 숫자 PK
        statusEl.textContent = `판매자: ${me.nickname ?? myUserId}`;

        // 2) 내가 속한 모든 채팅방 조회
        const roomsRes = await fetch(`/api/chat/rooms?userId=${encodeURIComponent(myUserId)}`, { credentials: 'include' });
        if (!roomsRes.ok) throw new Error('채팅방 목록 조회 실패');
        const allRooms = await roomsRes.json();

        // 3) 판매자로서 속한 방만 필터(sellerId == myUserId)
        const sellerRooms = (allRooms || []).filter(r => String(r.sellerId) === String(myUserId));

        listEl.innerHTML = '';
        if (sellerRooms.length === 0) {
          listEl.innerHTML = `<li class="empty">판매 채팅방이 없습니다.</li>`;
          return;
        }

        // 최신 생성 순(선택)
        sellerRooms.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        // 4) 목록 렌더
        sellerRooms.forEach(room => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div><strong>방번호:</strong> ${room.roomId} &nbsp; <strong>상품ID:</strong> ${room.listingId}</div>
            <div class="meta">
              구매자ID: ${room.buyerId ?? '-'} &nbsp;|&nbsp;
              상태: ${room.status || 'OPEN'} &nbsp;|&nbsp;
              생성: ${room.createdAt ? new Date(room.createdAt).toLocaleString() : '-'}
            </div>
          `;
          li.addEventListener('click', () => {
            // 입장: roomId만 넘기면 chatPage.html에서 roomId 기준으로 메시지 조회
            location.href = `/chatPage.html?roomId=${room.roomId}`;
          });
          listEl.appendChild(li);
        });

      } catch (err) {
        console.error(err);
        errorEl.textContent = `오류: ${err.message}`;
      }
    });
</script>
</body>
</html>
