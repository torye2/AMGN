<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>채팅방</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- SockJS / STOMP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <!-- 공용 CSS (기존) -->
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/header.css" />

    <style>
        :root{
          --chat-bg:#f7f8fb;
          --bubble-me:#4f46e5;
          --bubble-me-text:#fff;
          --bubble-other:#ffffff;
          --bubble-other-text:#111827;
          --border:#e5e7eb;
        }

        body{ background:#fff; }

        .chat-container{
          max-width: 840px;
          margin: 24px auto;
          padding: 0 16px 24px;
        }

        /* 상단 바 */
        .chat-header{
          display:flex; align-items:center; justify-content:space-between;
          gap:12px; padding:12px 14px; border:1px solid var(--border);
          border-radius:12px; background:#fff; box-shadow:0 2px 10px rgba(17,24,39,.04);
          margin-bottom:12px;
        }
        .room-meta{ display:flex; align-items:center; gap:10px; min-width:0; }
        .room-title{
          font-weight:800; font-size:16px; color:#111827; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        }
        .room-sub{
          color:#6b7280; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        }
        .online-dot{
          width:10px; height:10px; border-radius:50%;
          background:#16a34a; box-shadow:0 0 0 3px rgba(22,163,74,.15);
        }
        .status-badge{
          font-size:12px; font-weight:700; padding:6px 10px; border-radius:999px;
          border:1px solid var(--border); background:#fff; color:#374151;
        }
        .status-badge.off{ background:#fff7f7; color:#b91c1c; border-color:#fecaca; }
        .status-badge.on{  background:#f0fdf4; color:#166534; border-color:#bbf7d0; }

        /* 채팅 영역 */
        .chat-wrap{
          border:1px solid var(--border);
          border-radius:14px;
          background:var(--chat-bg);
          height: 60vh; min-height: 360px;
          display:flex; flex-direction:column; overflow:hidden;
          box-shadow:0 2px 10px rgba(17,24,39,.04);
        }
        .chat-log{
          flex:1 1 auto; overflow-y:auto; padding:16px 14px; scroll-behavior:smooth;
        }
        .day-sep{ text-align:center; margin:8px 0; font-size:12px; color:#6b7280; }

        /* 메시지 한 줄 */
        .msg{
          width:100%;
          display:flex; gap:8px; margin:8px 0; align-items:flex-end;
        }
        .msg.me{ justify-content:flex-end; }

        /* 아바타 */
        .msg .avatar{
          width:28px; height:28px; border-radius:50%; background:#e5e7eb; flex:0 0 auto; overflow:hidden;
          border:1px solid var(--border);
        }
        .msg.me .avatar{ display:none; }

        /* 🔑 말풍선 래퍼가 줄 폭의 상한을 담당 */
        .msg .msg-box{
          flex: 0 1 86%;
          max-width: 86%;
        }
        /* 필요하면 더 넓게
        .msg .msg-box{ flex:0 1 92%; max-width:92%; }
        */

        /* 말풍선 자체 */
        .bubble{
          display:inline-block;
          max-width:100%;                 /* 상한은 msg-box가 정함 */
          padding:10px 12px; border-radius:14px;
          font-size:14px; line-height:1.5;
          box-shadow:0 1px 4px rgba(17,24,39,.08);

          /* 줄바꿈 전략 */
          white-space: normal;            /* 개행 보존 X → 가로로 펼침 */
          word-break: keep-all;           /* 한글 단어 단위 줄바꿈 */
          overflow-wrap: anywhere;        /* 긴 URL 등만 강제 줄바꿈 */
        }
        .msg.me .bubble{
          background:var(--bubble-me); color:var(--bubble-me-text);
          border-bottom-right-radius:6px;
        }
        .msg.other .bubble{
          background:var(--bubble-other); color:var(--bubble-other-text);
          border-bottom-left-radius:6px;
        }

        .meta-line{
          display:flex; align-items:center; gap:8px;
          font-size:12px; color:#9ca3af; margin-top:4px;
        }
        .nick{ font-weight:700; color:#374151; }
        .time{ white-space:nowrap; }

        /* 입력영역 */
        .chat-input{
          display:flex; gap:8px; padding:10px; background:#fff; border-top:1px solid var(--border);
        }
        .chat-input input{
          flex:1; height:42px; border:1px solid var(--border); border-radius:10px; padding:0 12px; font-size:14px; outline:none;
        }
        .chat-input input:focus{ border-color:#c7d2fe; box-shadow:0 0 0 3px #eef2ff; }
        .chat-input button{
          padding:0 14px; border:none; border-radius:10px; background:#111827; color:#fff; font-weight:700; cursor:pointer;
        }
        .chat-input button:disabled{ opacity:.55; cursor:not-allowed; }

        .sys{ text-align:center; font-size:12px; color:#6b7280; margin:6px 0; }
        .error{ color:#b91c1c; background:#fff1f2; border:1px solid #fecdd3; padding:8px 10px; border-radius:8px; margin-top:10px; }

        /* 말풍선 래퍼를 컬럼 컨테이너로 */
.msg .msg-box{
  flex: 0 1 86%;
  max-width: 86%;
  display: flex;
  flex-direction: column;
  align-items: flex-start;   /* 기본: 왼쪽 정렬 */
}

/* 내 메시지는 오른쪽으로 붙이기 */
.msg.me .msg-box{
  align-items: flex-end; /* 말풍선/메타 모두 오른쪽 정렬 */
  margin-right: 10px;
}

/* 메타 줄 정렬 */
.msg.other .meta-line{ justify-content: flex-start; }
.msg.me    .meta-line{ justify-content: flex-end; }

/* 혹시 남는 여백이 있으면 말풍선 자체도 우측으로 밀기 */
.msg.other .bubble{ margin-right: auto; }
.msg.me    .bubble{ margin-left:  auto; }  /* inline-block이라도 안전하게 */

    </style>
</head>
<body>
<header id="header"></header>

<main class="chat-container">
    <div class="chat-header">
        <div class="room-meta" style="min-width:0;">
            <span class="online-dot" id="onlineDot" aria-hidden="true"></span>
            <div style="min-width:0;">
                <div class="room-title" id="roomTitle">채팅방</div>
                <div class="room-sub" id="roomSub">연결 상태 확인 중…</div>
            </div>
        </div>
        <span class="status-badge off" id="connBadge">오프라인</span>
    </div>

    <section class="chat-wrap" aria-live="polite">
        <div id="chat" class="chat-log"></div>
        <form id="messageForm" class="chat-input" autocomplete="off">
            <input id="msg" type="text" placeholder="메시지를 입력하세요…" />
            <button type="submit" id="sendBtn" disabled>보내기</button>
        </form>
    </section>

    <div id="error" class="error" role="alert" style="display:none;"></div>
</main>

<script>
    (() => {
      // ----- Params -----
      const qs        = new URLSearchParams(location.search);
      const roomId    = Number(qs.get('roomId'));
      const listingId = qs.get('listingId'); // 선택
      const sellerId  = qs.get('sellerId');  // 선택
      if (!roomId || Number.isNaN(roomId)) alert('roomId가 없습니다. 채팅 목록에서 다시 들어와 주세요.');

      // ----- DOM -----
      const chatEl    = document.getElementById('chat');
      const formEl    = document.getElementById('messageForm');
      const inputEl   = document.getElementById('msg');
      const sendBtn   = document.getElementById('sendBtn');
      const errEl     = document.getElementById('error');
      const connBadge = document.getElementById('connBadge');
      const roomTitle = document.getElementById('roomTitle');
      const roomSub   = document.getElementById('roomSub');
      const onlineDot = document.getElementById('onlineDot');

      // ----- State -----
      let stomp = null;
      let me = { userId: null, nickname: null };
      let connected = false;

      // ----- Utils -----
      const fmtTime = (isoOrTs) => {
        try{
          const d = isoOrTs ? new Date(isoOrTs) : new Date();
          const HH = String(d.getHours()).padStart(2,'0');
          const mm = String(d.getMinutes()).padStart(2,'0');
          return `${HH}:${mm}`;
        }catch{ return ''; }
      };
      const setConn = (on) => {
        connected = !!on;
        connBadge.textContent = on ? '온라인' : '오프라인';
        connBadge.classList.toggle('on', on);
        connBadge.classList.toggle('off', !on);
        onlineDot.style.background = on ? '#16a34a' : '#9ca3af';
        sendBtn.disabled = !on;
      };
      const scrollToBottom = () => { chatEl.scrollTop = chatEl.scrollHeight; };

      // ----- Message DOM -----
      function appendMessage({ content, senderNickName, senderId, createdAt }) {
        const isMe = me.userId != null && senderId != null && String(me.userId) === String(senderId);

        const row = document.createElement('div');
        row.className = `msg ${isMe ? 'me' : 'other'}`;

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        if (!isMe) row.appendChild(avatar);

        const box = document.createElement('div');
        box.className = 'msg-box';

        const bubble = document.createElement('div');
        bubble.className = 'bubble';

        // 🔑 개행들을 공백 1개로 정리해 가로 확장 유도
        const cleaned = String(content ?? '').replace(/(\r\n|\r|\n)+/g, ' ');
        bubble.textContent = cleaned;

        const meta = document.createElement('div');
        meta.className = 'meta-line';
        meta.innerHTML = `${!isMe ? `<span class="nick">${senderNickName || '상대'}</span>` : ''}<span class="time">${fmtTime(createdAt)}</span>`;

        box.appendChild(bubble);
        box.appendChild(meta);
        row.appendChild(box);
        chatEl.appendChild(row);
      }

      // ----- Header Info -----
      async function hydrateHeader() {
        try {
          const r = await fetch('/api/user/me', { credentials:'include', cache:'no-store' });
          if (r.ok) {
            const j = await r.json();
            me.userId  = j.userId ?? j.user_id ?? null;
            me.nickname = j.nickname ?? j.nickName ?? null;
          }
        } catch {}

        try {
          if (listingId) {
            const r = await fetch(`/product/${encodeURIComponent(listingId)}`, { credentials:'include' });
            if (r.ok) {
              const p = await r.json();
              roomTitle.textContent = p.title ?? '채팅방';
              roomSub.textContent   = `상품 #${p.listingId ?? listingId}`;
              return;
            }
          }
          roomTitle.textContent = '채팅방';
          roomSub.textContent   = `Room #${roomId}`;
        } catch {
          roomTitle.textContent = '채팅방';
          roomSub.textContent   = `Room #${roomId}`;
        }
      }

      // ----- WebSocket -----
      function connect() {
        const socket = new SockJS('/ws');
        stomp = Stomp.over(socket);
        stomp.debug = () => {}; // quiet

        stomp.connect({}, () => {
          setConn(true);
          stomp.subscribe('/topic/messages', (msg) => {
            try {
              const payload = JSON.parse(msg.body);
              if (Number(payload.roomId) === Number(roomId)) {
                appendMessage(payload);
                scrollToBottom();
              }
            } catch(e) { console.error('메시지 파싱 실패:', e); }
          });
        }, () => {
          setConn(false);
          setTimeout(connect, 1500);
        });
      }

      // ----- History -----
      async function loadPreviousMessages() {
        try{
          const res = await fetch(`/chat/messages?roomId=${encodeURIComponent(roomId)}`, { credentials:'include' });
          if (!res.ok) throw new Error('이전 메시지 조회 실패');
          const arr = await res.json();
          chatEl.innerHTML = '';

          let lastDay = '';
          (arr || []).forEach(m => {
            const d = new Date(m.createdAt);
            const day = [d.getFullYear(), d.getMonth()+1, d.getDate()].join('-');
            if (day !== lastDay) {
              const sep = document.createElement('div');
              sep.className = 'day-sep';
              sep.textContent = day;
              chatEl.appendChild(sep);
              lastDay = day;
            }
            appendMessage(m);
          });
          scrollToBottom();
        }catch(e){
          errEl.style.display = 'block';
          errEl.textContent = e.message || '이전 메시지를 불러오지 못했습니다.';
        }
      }

      // ----- Send -----
      formEl.addEventListener('submit', (ev) => {
        ev.preventDefault();
        if (!connected || !stomp) return;

        const text = inputEl.value.trim();
        if (!text) return;

        const msg = {
          roomId: roomId,
          msgType: 'TEXT',
          content: text
        };
        if (listingId) msg.listingId = Number(listingId);
        if (sellerId)  msg.sellerId  = Number(sellerId);

        stomp.send('/app/chat/send', {}, JSON.stringify(msg));
        inputEl.value = '';
        inputEl.focus();
      });

      inputEl.addEventListener('input', () => {
        sendBtn.disabled = !inputEl.value.trim() || !connected;
      });

      // ----- Boot -----
      if (roomId && !Number.isNaN(roomId)) {
        hydrateHeader();
        loadPreviousMessages();
        connect();
      }
    })();
</script>

<script src="/js/header.js"></script>
</body>
</html>
