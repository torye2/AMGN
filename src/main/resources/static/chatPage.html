<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì±„íŒ…ë°©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        #chat { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 8px; margin-bottom: 12px; }
        #messageForm { display: flex; gap: 8px; }
        #messageForm input { flex: 1; padding: 8px; }
        #messageForm button { padding: 8px 12px; }
    </style>
</head>
<body>
<h1>ì±„íŒ…ë°©</h1>
<div id="chat"></div>

<form id="messageForm">
    <input type="text" id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off" />
    <button type="submit">ë³´ë‚´ê¸°</button>
</form>

<script>
    const params = new URLSearchParams(window.location.search);
    const roomId   = Number(params.get('roomId'));
    const listingId = params.get('listingId'); // ì„ íƒì (ë°±ì—”ë“œ í•˜ìœ„í˜¸í™˜)
    const sellerId  = params.get('sellerId');  // ì„ íƒì (ë°±ì—”ë“œ í•˜ìœ„í˜¸í™˜)

    if (!roomId || Number.isNaN(roomId)) {
      alert("roomIdê°€ ì—†ìŠµë‹ˆë‹¤. ì±„íŒ… ëª©ë¡ì—ì„œ ë‹¤ì‹œ ë“¤ì–´ì™€ ì£¼ì„¸ìš”.");
    }

    let stompClient = null;

    function connect() {
      const socket = new SockJS('/ws');
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function () {
        console.log('WebSocket ì—°ê²°ë¨');

        // ëª¨ë“  ë©”ì‹œì§€ë¥¼ êµ¬ë…í•˜ë˜, í˜„ì¬ roomIdì˜ ë©”ì‹œì§€ë§Œ ì¶œë ¥
        stompClient.subscribe('/topic/messages', function (msg) {
          try {
            const message = JSON.parse(msg.body);
            if (message.roomId === roomId) {
              showMessage(message);
            }
          } catch (e) {
            console.error('ë©”ì‹œì§€ íŒŒì‹± ì‹¤íŒ¨:', e);
          }
        });
      });
    }

    function loadPreviousMessages() {
      // âœ… roomIdë¡œ ì´ì „ ë©”ì‹œì§€ ì¡°íšŒ
      fetch(`/chat/messages?roomId=${roomId}`)
        .then(res => {
          if (!res.ok) throw new Error('ì´ì „ ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨');
          return res.json();
        })
        .then(messages => {
          messages.forEach(showMessage);
        })
        .catch(err => console.error('ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err));
    }

    function sendMessage(event) {
      event.preventDefault();
      if (!stompClient) return;

      const input = document.getElementById('msg');
      const content = input.value.trim();
      if (!content) return;

      // âœ… ê¸°ë³¸ì€ roomId & ë‚´ìš©ë§Œ ì „ì†¡
      const chatMessage = {
        roomId: roomId,
        msgType: 'TEXT',
        content: content
      };

      // ğŸ” í•˜ìœ„í˜¸í™˜: URLì— listingId/sellerIdê°€ ìˆìœ¼ë©´ ê°™ì´ ë³´ëƒ„
      if (listingId) chatMessage.listingId = Number(listingId);
      if (sellerId)  chatMessage.sellerId  = Number(sellerId);

      stompClient.send('/app/chat/send', {}, JSON.stringify(chatMessage));
      input.value = '';
    }

    function showMessage(message) {
      const chatDiv = document.getElementById('chat');

      const p = document.createElement('p');
      const nick = message.senderNickName || 'ì•Œìˆ˜ì—†ìŒ';
      p.textContent = `${nick}: ${message.content}`;

      chatDiv.appendChild(p);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    document.getElementById('messageForm').addEventListener('submit', sendMessage);

    if (roomId && !Number.isNaN(roomId)) {
      loadPreviousMessages();
      connect();
    }
</script>
</body>
</html>
