<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>상품 검색 (title 완전일치)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: system-ui, sans-serif; margin: 24px; }
        form { display: flex; gap: 8px; margin-bottom: 16px; }
        input[type="text"] { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; }
        button[type="submit"] { background: #222; color: #fff; }
        .count { margin: 8px 0 16px; color: #555; }
        .card { border: 1px solid #eee; border-radius: 12px; padding: 14px; margin-bottom: 10px; }
        .title { font-weight: 700; margin-bottom: 6px; }
        .meta { font-size: 14px; color: #666; }
        .empty { color: #888; }
    </style>
</head>
<body>
<h1>상품 검색</h1>

<form id="searchForm">
    <input id="titleInput" type="text" placeholder="title을 정확히 입력하세요 (예: 아이폰13)" required />
    <button type="submit">검색</button>
    <button type="button" id="resetBtn">초기화</button>
</form>

<div class="count" id="countArea"></div>
<div id="results"></div>

<script>
    const form = document.getElementById('searchForm');
    const input = document.getElementById('titleInput');
    const results = document.getElementById('results');
    const countArea = document.getElementById('countArea');
    const resetBtn = document.getElementById('resetBtn');

    function render(list) {
      results.innerHTML = '';
      countArea.textContent = `검색 결과: ${list.length}건`;
      if (!list.length) {
        results.innerHTML = `<p class="empty">일치하는 상품이 없습니다.</p>`;
        return;
      }
      for (const item of list) {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="title">${escapeHtml(item.title)}</div>
          <div class="meta">가격: ${formatPrice(item.price)} ${item.currency || ''} | 상태: ${item.status || ''}</div>
          <div class="meta">ID: ${item.listingId}</div>
        `;
        results.appendChild(div);
      }
    }

    function formatPrice(v) {
      if (v === null || v === undefined) return '';
      // 서버에서 NUMBER(12,0) → JSON은 보통 숫자 or 문자열로 옴
      const n = Number(v);
      return Number.isFinite(n) ? n.toLocaleString() : v;
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = input.value.trim();
      if (!title) return;
      try {
        countArea.textContent = '검색 중...';
        results.innerHTML = '';
        const res = await fetch(`/product/search?title=${encodeURIComponent(title)}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        render(data);
      } catch (err) {
        countArea.textContent = '오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
        console.error(err);
      }
    });

    resetBtn.addEventListener('click', () => {
      input.value = '';
      countArea.textContent = '';
      results.innerHTML = '';
      input.focus();
    });
</script>

<div>
    <footer id="footer"></footer>
</div>
<script src="js/footer.js"></script>
</body>
</html>
