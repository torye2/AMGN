<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>리뷰 페이지</title>
	<link rel="stylesheet" href="/css/reset.css">
    <link rel="stylesheet" href="/css/main.css">
	

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/product.css">
</head>
<body>
    <h1>리뷰 페이지</h1>

    <!-- 리뷰 작성 폼 -->
    <section>
        <h2>리뷰 작성</h2>
        <form id="review-form">
            <input type="hidden" id="orderId" value="456"> <!-- 주문 ID 예시 -->
            <label>
                평점 (1~5):
                <input type="number" id="score" min="1" max="5" required>
            </label>
            <br>
            <label>
                댓글:
                <textarea id="rvComment" maxlength="500"></textarea>
            </label>
            <br>
            <button type="submit">작성</button>
        </form>
    </section>

    <hr>

    <!-- 리뷰 리스트 -->
    <section>
        <h2>리뷰 목록</h2>
        <div id="review-list">
            <!-- 리뷰 항목이 여기 들어감 -->
        </div>
    </section>

    <script>
        // 로그인한 사용자 ID 예시 (raterId)
        const raterId = 123; 
        // 리뷰 조회할 사용자 ID (rateeId)
        const userId = 123; 
        const limit = 20;

        // 리뷰 리스트 불러오기
        async function loadReviews() {
            try {
                const res = await fetch(`/api/reviews/users/${userId}?limit=${limit}`);
                if (!res.ok) return;
                
                const reviews = await res.json();
                const listDiv = document.getElementById("review-list");
                listDiv.innerHTML = "";

                if (reviews.length === 0) {
                    listDiv.innerHTML = "<p>리뷰가 없습니다.</p>";
                    return;
                }

                reviews.forEach(r => {
                    const item = document.createElement("div");
                    item.innerHTML = `
                        <p><strong>작성자 ID:</strong> ${r.raterId}</p>
                        <p><strong>평점:</strong> ${r.score}</p>
                        <p><strong>댓글:</strong> ${r.rvComment || "-"}</p>
                        <p><em>${new Date(r.createdAt).toLocaleString()}</em></p>
                        <hr>
                    `;
                    listDiv.appendChild(item);
                });
            } catch (err) {
                alert(err.message);
            }
        }

        // 리뷰 작성
        document.getElementById("review-form").addEventListener("submit", async (e) => {
            e.preventDefault();

            const payload = {
                orderId: Number(document.getElementById("orderId").value),
                score: Number(document.getElementById("score").value),
                rvComment: document.getElementById("rvComment").value
            };

            try {
                const res = await fetch(`/api/reviews?uid=${raterId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.message || "리뷰 작성 중 오류 발생");
                }

                alert("리뷰 작성 완료!");
                document.getElementById("review-form").reset();
                loadReviews(); // 작성 후 리스트 갱신
            } catch (err) {
                alert(err.message);
            }
        });

        // 페이지 로딩 시 리뷰 불러오기
        window.addEventListener("DOMContentLoaded", loadReviews);
    </script>
    <script src="/js/header.js"></script>
</body>
</html>
