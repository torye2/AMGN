<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<title>ë¦¬ë·° í˜ì´ì§€</title>
	<link rel="stylesheet" href="/css/reset.css">
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/css/review.css">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&display=swap" rel="stylesheet">
</head>
<body>

<!-- í—¤ë” -->
<div id="header"></div>

<div id="box"></div>

<div class="container">
	<fieldset class="review-box">
		<h1>ë¦¬ë·° ê´€ë¦¬</h1>
		<div class="review-question">
			<h2>ğŸ—¯ï¸ìƒí’ˆ í’ˆì§ˆ ë¦¬ë·°</h2>
			<p>ìƒí’ˆì˜ í’ˆì§ˆì— ëŒ€í•´ ì–´ë–»ê²Œ ìƒê°í•˜ì‹œë‚˜ìš”?</p>
		</div>


		<!-- ë¦¬ë·° ì‘ì„± í¼ -->
		<form id="review-form">
			<label for="orderSelect">ì£¼ë¬¸ ì„ íƒ :</label>
			<select id="orderSelect" required>
				<option value="">-- ì£¼ë¬¸ ì„ íƒ --</option>
			</select><br>

			<label id="starRatingfont" for="score">ë³„ì  :</label>
			<div id="starRating">
				<span class="star" data-value="1">â­</span>
				<span class="star" data-value="2">â­</span>
				<span class="star" data-value="3">â­</span>
				<span class="star" data-value="4">â­</span>
				<span class="star" data-value="5">â­</span>
			</div>
			<input type="hidden" id="score" required><br>

			<label for="rvCommentTextarea">ëŒ“ê¸€ ì‘ì„±</label>
			<textarea id="rvCommentTextarea"></textarea>

			<button type="submit">ì‘ì„±</button>

		</form>
	</fieldset>
</div>
<!-- ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ + í‰ê·  í‰ì 
<section>
    <h2>ë¦¬ë·° ëª©ë¡ (í‰ê·  í‰ì : <span id="ratingAverage">-</span>)</h2>
    <div id="review-list"></div>
</section>

<script>
// í˜ì´ì§€ ë¡œë”© ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', async () => {
    // 1. í—¤ë” ë¡œë“œ
    fetch('/review/header.html')
        .then(res => res.text())
        .then(html => document.getElementById('header').innerHTML = html)
        .catch(err => console.error('í—¤ë” ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', err));

    // 2. ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸°
    await fetchOrders();
});

// ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì£¼ë¬¸ ê°€ì ¸ì˜¤ê¸°
async function fetchOrders() {
    try {
        const res = await fetch('/api/orders/mine');
        if (!res.ok) return;
        const orders = await res.json();
        const select = document.getElementById('orderSelect');
        orders.forEach(order => {
            const option = document.createElement('option');
            option.value = order.id; // OrderDtoì—ì„œ id í•„ë“œ
            option.textContent = `ì£¼ë¬¸ ${order.id} - ${order.itemTitle || 'ì œëª© ì—†ìŒ'}`;
            select.appendChild(option);
        });
    } catch(err) {
        console.error('ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', err);
    }
}

// ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ + í‰ê·  í‰ì  ê°±ì‹ 
async function loadReviews(orderId) {
    if (!orderId) return;

    try {
        const res = await fetch(`/api/reviews/orders/${orderId}`);
        if (!res.ok) return;

        const reviews = await res.json();
        const listDiv = document.getElementById('review-list');
        listDiv.innerHTML = "";

        if (reviews.length === 0) {
            listDiv.innerHTML = "<p>ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            document.getElementById('ratingAverage').textContent = "-";
            return;
        }

        let sum = 0;
        reviews.forEach(r => {
            sum += r.score;
            const div = document.createElement('div');
            div.innerHTML = `
                <p><strong>ì‘ì„±ì:</strong> ${r.raterNickName || r.raterId}</p>
                <p><strong>í‰ì :</strong> ${r.score}</p>
                <p><strong>ëŒ“ê¸€:</strong> ${r.rvComment || "-"}</p>
                <p><em>${new Date(r.createdAt).toLocaleString()}</em></p>
                <hr>
            `;
            listDiv.appendChild(div);
        });

        const avg = (sum / reviews.length).toFixed(1);
        document.getElementById('ratingAverage').textContent = avg;
    } catch(err) {
        console.error('ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', err);
    }
}

// ë¦¬ë·° ì‘ì„±
async function fetchOrders() {
    try {
        const res = await fetch('/api/reviews/mine'); // review ì „ìš©
        if (!res.ok) return;
        const orders = await res.json();
        const select = document.getElementById('orderSelect');
        orders.forEach(order => {
            const option = document.createElement('option');
            option.value = order.orderId;
            option.textContent = `ì£¼ë¬¸ ${order.orderId} - ${order.itemTitle}`;
            select.appendChild(option);
        });
    } catch(err) {
        console.error('ì£¼ë¬¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', err);
    }
}

async function loadReviews(orderId) {
    if (!orderId) return;
    try {
        const res = await fetch(`/api/reviews/orders/${orderId}`);
        if (!res.ok) return;
        const reviews = await res.json();
        const listDiv = document.getElementById('review-list');
        listDiv.innerHTML = "";
        if (reviews.length === 0) {
            listDiv.innerHTML = "<p>ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
            document.getElementById('ratingAverage').textContent = "-";
            return;
        }
        let sum = 0;
        reviews.forEach(r => {
            sum += r.score;
            const div = document.createElement('div');
            div.innerHTML = `
                <p><strong>ì‘ì„±ì:</strong> ${r.raterId}</p>
                <p><strong>í‰ì :</strong> ${r.score}</p>
                <p><strong>ëŒ“ê¸€:</strong> ${r.rvComment || "-"}</p>
                <p><em>${new Date(r.createdAt).toLocaleString()}</em></p>
                <hr>
            `;
            listDiv.appendChild(div);
        });
        const avg = (sum / reviews.length).toFixed(1);
        document.getElementById('ratingAverage').textContent = avg;
    } catch(err) {
        console.error('ë¦¬ë·° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨', err);
    }
}

</script>
-->
<script src="/js/header.js"></script>
<script src="/review/js/review.js"></script>
</body>
</html>