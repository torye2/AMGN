<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>비밀번호 재설정</title>
  <link rel="stylesheet" href="/css/reset.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/find.css" />
</head>
<body>
<div id="wrap">
  <div>
    <header id="header"></header>
  </div>

  <div id="formError" class="form-alert" aria-live="polite"></div>

  <fieldset class="find-box">
    <h1>비밀번호 재설정</h1>

    <div class="row">
      <label for="userId">아이디</label>
      <input type="text" id="userId" required />
    </div>

    <div class="row">
      <label for="name">이름</label>
      <input type="text" id="name" autocomplete="name" required />
    </div>

    <div class="row">
      <label>생년월일</label>
      <div class="inline-3">
        <input id="birthYear" type="number" placeholder="년(YYYY)" min="1900" max="2100" required />
        <select id="birthMonth" required>
          <option value="">월</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option><option value="9">9</option>
          <option value="10">10</option><option value="11">11</option><option value="12">12</option>
        </select>
        <select id="birthDay" required>
          <option value="">일</option>
        </select>
      </div>
    </div>

    <div class="row">
      <label for="phone">핸드폰 번호</label>
      <input type="tel" id="phone" inputmode="tel" placeholder="010-1234-5678" required />
    </div>

    <button class="btn" id="btnCheck" type="button">본인 확인</button>

    <div id="resetBox" style="display:none;">
      <div class="row" style="margin-top:10px;">
        <label for="pw1">새 비밀번호</label>
        <input type="password" id="pw1" required />
      </div>
      <div class="row">
        <label for="pw2">새 비밀번호 확인</label>
        <input type="password" id="pw2" required />
      </div>
      <button class="btn" id="btnReset" type="button">비밀번호 변경</button>
    </div>
  </fieldset>
</div>
<script src="js/header.js"></script>
<script>
// populate day select based on month/year
(function(){
  const daySel = document.getElementById('birthDay');
  function fillDays(){
    const y = parseInt(document.getElementById('birthYear').value || '2000', 10);
    const m = parseInt(document.getElementById('birthMonth').value || '1', 10);
    const last = new Date(y, m, 0).getDate();
    daySel.innerHTML = '<option value="">일</option>';
    for(let d=1; d<=last; d++){
      const opt = document.createElement('option');
      opt.value = String(d);
      opt.textContent = String(d);
      daySel.appendChild(opt);
    }
  }
  document.getElementById('birthYear').addEventListener('input', fillDays);
  document.getElementById('birthMonth').addEventListener('change', fillDays);
  fillDays();
})();

const $ = (s)=>document.querySelector(s);
const showError = (msg)=>{ const el=$('#formError'); el.textContent=msg||''; };
let resetToken = null;

$('#btnCheck').addEventListener('click', async ()=>{
  showError('');
  const userId = $('#userId').value.trim();
  const name = $('#name').value.trim();
  const birthYear = $('#birthYear').value.trim();
  const birthMonth = $('#birthMonth').value.trim();
  const birthDay = $('#birthDay').value.trim();
  const phone = $('#phone').value.trim();

  if(!userId || !name || !birthYear || !birthMonth || !birthDay || !phone){
    showError('모든 값을 입력해 주세요.');
    return;
  }

  try {
    const resp = await fetch('/api/pw-reset/check', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ userId, name, birthYear:Number(birthYear), birthMonth:Number(birthMonth), birthDay:Number(birthDay), phone })
    });
    if(resp.ok){
      const data = await resp.json(); // { resetToken: '...' }
      resetToken = data.resetToken;
      document.getElementById('resetBox').style.display='block';
    } else if(resp.status === 404){
      showError('일치하는 회원 정보를 찾을 수 없습니다.');
    } else {
      showError('요청 처리 중 오류가 발생했습니다.');
    }
  } catch(e){
    showError('네트워크 오류가 발생했습니다.');
  }
});

$('#btnReset').addEventListener('click', async ()=>{
  showError('');
  const pw1 = $('#pw1').value;
  const pw2 = $('#pw2').value;

  if(pw1 !== pw2){
    showError('비밀번호가 일치하지 않습니다.');
    return;
  }
  if(!resetToken){
    showError('본인 확인을 먼저 진행해 주세요.');
    return;
  }

  try {
    const resp = await fetch('/api/pw-reset/commit', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ resetToken, newPassword: pw1 })
    });
    if(resp.ok){
      alert('비밀번호가 변경되었습니다. 다시 로그인해 주세요.');
      location.href = '/login.html';
    } else {
      showError('변경 실패. 다시 시도해 주세요.');
    }
  } catch(e){
    showError('네트워크 오류가 발생했습니다.');
  }
});
</script>
</body>
</html>
