<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="amgn.amu.mapper.OauthIdentityMapper">

    <resultMap id="UserMfaTotp" type="amgn.amu.entity.OauthIdentity">
        <id property="oauthId" column="oauth_id" />
        <result property="userId" column="user_id" />
        <result property="provider" column="provider" />
        <result property="providerUserId" column="provider_user_id" />
        <result property="email" column="email" />
        <result property="displayName" column="display_name" />
        <result property="accessToken" column="access_token"/>
        <result property="refreshToken" column="refresh_token"/>
        <result property="tokenExpiresAt" column="token_expires_at"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="findUserByProvider" resultType="amgn.amu.domain.User">
        SELECT U.*
        FROM oauth_identities OI
        JOIN USERS U ON U.USER_ID = OI.USER_ID
        WHERE OI.PROVIDER = #{provider}
        AND OI.PROVIDER_USER_ID = #{pid}
        LIMIT 1
    </select>

    <select id="findByProvider" resultType="amgn.amu.entity.OauthIdentity">
        SELECT *
        FROM oauth_identities
        WHERE PROVIDER = #{provider}
        AND PROVIDER_USER_ID = #{pid}
        LIMIT 1
    </select>

    <insert id="insertLink" parameterType="amgn.amu.entity.OauthIdentity"
            useGeneratedKeys="true" keyProperty="oauthId">
        INSERT INTO oauth_identities
                (USER_ID, PROVIDER, PROVIDER_USER_ID, EMAIL, DISPLAY_NAME, ACCESS_TOKEN,
                 REFRESH_TOKEN, TOKEN_EXPIRES_AT, CREATED_AT, UPDATED_AT)
        VALUES
            (#{userId}, #{provider}, #{providerUserId}, #{email}, #{displayName}, #{accessToken}, #{refreshToken}, #{tokenExpiresAt}, NOW(), NOW())
            AS new
            ON DUPLICATE KEY UPDATE
                                 email=COALESCE(new.email, oauth_identities.email),
                                 display_name=COALESCE(new.display_name, oauth_identities.display_name),
                                 access_token=new.access_token,
                                 refresh_token=new.refresh_token,
                                 token_expires_at=new.token_expires_at,
                                 updated_at=NOW()
    </insert>

    <update id="updateTokens" parameterType="amgn.amu.entity.OauthIdentity">
        UPDATE oauth_identities
        SET access_token = #{accessToken},
            refresh_token = #{refreshToken},
            token_expires_at = #{tokenExpiresAt},
            updated_at = NOW()
        WHERE provider = #{provider} AND provider_user_id = #{providerUserId}
    </update>

    <select id="findProvidersByUserId" resultType="string">
        SELECT PROVIDER
        FROM oauth_identities
        WHERE USER_ID = #{userId}
    </select>

    <delete id="deleteLinkByUserAndProvider">
        DELETE FROM oauth_identities
        WHERE USER_ID = #{userId} AND PROVIDER = #{provider}
    </delete>

    <select id="findUserIdByProviderAndPid">
        SELECT USER_ID
        FROM oauth_identities
        WHERE PROVIDER = #{provider} AND PROVIDER_USER_ID = #{pid}
    </select>

    <delete id="deleteByUserId">
        DELETE FROM oauth_identities WHERE USER_ID = #{userId}
    </delete>
</mapper>